!function(e,t,r){function a(e,t){return{name:"StreamComplete::"+e,level:"Cannot continue",message:t,htmlMessage:t,toString:function(){return["StreamComplete::",e," - ",t].join("")}}}function o(){e(".streamcomplete-body").length||e("body").append('<div class="streamcomplete-body"></div>')}var n=function(){},s={init:function(a){var s=this;if(!s.length||s.data("streamcomplete"))return s;if(s.length>1)return s.each(function(){e(this).streamComplete(a)}),s;var l={instanceid:++t,s:e.fn.extend({delay:250,minlength:2,onajaxerror:n,onbeforeajaxsearch:n,onbeforesearch:n,onchange:n,onclose:n,onerror:n,onfocusin:n,onfocusout:n,oninit:n,onresponse:n,onsearch:n,onselect:n,src:[]},a),searchterm:null},c=!1,u=!1,m={DOWN:40,ENTER:13,SPACE:32,TAB:9,UP:38,ESC:27},d=-1,h=!1;l.renderResult=function(t){var r=document.createElement("div");return e(r).html(t.value).data("sc-desc",t).addClass("streamcomplete-result"),r},l.render=function(t){var r=e(".streamcomplete-body").show(),a=s.offset(),o=s[0].getBoundingClientRect();r.css({width:s.width(),top:a.top+o.height,left:a.left}).empty();for(var n=0;t?n<t.length:0;n++){var c=t[n];"[object Object]"!==Object.prototype.toString.call(c)&&(c={id:n,value:c});var i=l.renderResult(c);r.append(i)}},l.afterRender=function(){var t=e(".streamcomplete-body"),r=t.data("sc-results");t.data("sc-results",r),e("body").unbind("click.streamcomplete").bind("click.streamcomplete",l.close)},l.close=function(t){var r=null;if(t){var a=e(t.target);if(a.closest(".streamcomplete-body").length){var r=a.data("sc-desc");if(l.s.onselect.call(s,r)===!1)return!1;s[0].value=r.value,s.data("value",r.id)}e("body").unbind("click.streamcomplete")}l.s.onclose.call(s,{selection:r,results:e(".streamcomplete-body").hide().data("sc-results")})},s.keydown(function(e){if(p(m,e.which)){var t=v(e.which);if(t===!1)return e.preventDefault(),h=!0,!1}}),s.keyup(function(){if(h)return h=!1,!1;l.searchterm=this.value;var e={term:l.searchterm};return d=-1,l.s.onbeforesearch.call(s,e)===!1?!1:(this.value.length>=+l.s.minlength?(u=!1,c!==!1&&r.clearTimeout(c),c=r.setTimeout(function(){if(u)return void(u=!1);var t=!1;switch(Object.prototype.toString.call(l.s.src)){case"[object String]":f(l.s.src,e);break;case"[object Array]":t=!0;case"[object Function]":var r=t?l.s.src:l.s.src();if(l.s.onsearch.call(s,r)===!1)return!1;l.render(r),l.afterRender()}},+l.s.delay)):(u=!0,l.close()),void s.data("streamcomplete",l))});var f=function(t,r){e.ajax({url:t,type:"post",dataType:"json",beforeSend:function(e){l.s.onbeforeajaxsearch.call(s,e)},data:{payload:JSON.stringify(r)}}).done(function(e){if("OK"===e.result){if(u)return void(u=!1);if(l.s.onresponse.call(s,e)===!1)return!1;if(c=!1,l.s.onsearch.call(s,e.data)===!1)return!1;l.render(e.data),l.afterRender()}else l.s.onerror.call(s,e)}).fail(function(e){l.s.onajaxerror.call(s,e)})},p=function(e,t){for(var r in e)if(e[r]===t)return!0;return!1},v=function(t){var r=e(".streamcomplete-result"),a=r.length;switch(t){case m.UP:return d=(0>d-1?a:d)-1,e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),e(r[d]).addClass("streamcomplete-result-hover"),!1;case m.DOWN:return d=d+1===a?0:d+1,e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),e(r[d]).addClass("streamcomplete-result-hover"),!1;case m.SPACE:case m.ENTER:case m.TAB:var o=e(".streamcomplete-result-hover");return o.length?(e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),l.close({target:o[0]}),!1):!0;case m.ESC:var o=e(".streamcomplete-result-hover");return o.length?(d=-1,e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),!1):!0}},b=["focusin","focusout"];for(i=0;i<b.length;i++){var g=b[i];s[g](function(t){var r=e(this).data("streamcomplete");"[object Function]"===Object.prototype.toString.call(r.s["on"+t.type])&&r.s["on"+t.type].call(this,t)})}return s.data("streamcomplete",l),o(),l.s.oninit.call(s),s},setValue:function(e){var t=this.data("streamcomplete");if(!t)throw a("InstanceError","A call to 'setValue' on an uninitialised object");this[0].value=e.value,this.data("value",e.id);for(var r in e)"id"!==r&&"value"!==r&&this.data(r,e[r]);return this.change()},clearValue:function(e){var t=this.data("streamcomplete");if(!t)throw a("InstanceError","A call to 'setValue' on an uninitialised object");for(this[0].value="",this.data("value",""),i=0;i<(e||[]).length;i++)this.data(e[i],"");return this.change()},updateOpts:function(t){var r=this.data("streamcomplete");if(!r)throw a("InstanceError","A call to 'setValue' on an uninitialised object");return r.s=e.extend(r.s,t),this.data("streamcomplete",r),this}};e.fn.streamComplete=function(t){var r=this;return s[t]?s[t].apply(r,Array.prototype.slice.call(arguments,1)):"[object Object]"!==Object.prototype.toString.call(t)&&t?void e.error(["The method ",t," does not exist"].join("")):s.init.apply(r,arguments)}}(jQuery,0,this);