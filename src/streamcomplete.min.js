!function(e,t,r,a){"use strict";function n(e,t){return{name:"StreamComplete::"+e,level:"Cannot continue",message:t,htmlMessage:t,toString:function(){return["StreamComplete::",e," - ",t].join("")}}}function o(){e(".streamcomplete-body").length||e("body").append('<div class="streamcomplete-body"></div>')}var l=null,s=function(){},c={init:function(n){function c(e){switch(Object.prototype.toString.call(e)){case"[object String]":e={id:j,value:e}}return!e.label&&e.value&&(e.label=e.value),!e.value&&e.label&&(e.value=e.label),e}var i=this,u={instanceid:++t,s:e.fn.extend({delay:250,minlength:2,onajaxerror:s,onbeforeajaxsearch:s,onbeforesearch:s,onclose:s,onerror:s,oninit:s,onresponse:s,onsearch:s,onselect:s,src:[]},n),searchterm:null},m=!1,h=!1,d={DOWN:40,ENTER:13,SPACE:32,TAB:9,UP:38,ESC:27},f=-1,p=!1;if(!i.length||i.data("streamcomplete"))return i;if(i.length>1)return i.each(function(){e(this).streamComplete(n)}),i;u.renderResult=function(t){var r=a.createElement("div");return e(r).html(t.label).data("sc-desc",t).addClass("streamcomplete-result"),r},u.render=function(t){var r=e(".streamcomplete-body").show(),a=i.offset(),n=i[0].getBoundingClientRect();r.css({width:n.width,top:a.top+n.height,left:a.left}).empty();for(var o=0;t?o<t.length:0;o++){var l=c(t[o]),s=u.renderResult(l);r.append(s)}},u.afterRender=function(){var t=e(".streamcomplete-body"),r=t.data("sc-results");t.data("sc-results",r),e("body").unbind("click.streamcomplete").bind("click.streamcomplete",u.close)},u.close=function(t){var r=null;if(t){var a=e(t.target);if(a.closest(".streamcomplete-body").length){var r=a.data("sc-desc");if(u.s.onselect.call(i,r)===!1)return!1;i[0].value=r.value,i.data("value",r.id)}e("body").unbind("click.streamcomplete")}u.s.onclose.call(i,{selection:r,results:e(".streamcomplete-body").hide().data("sc-results")})},i.keydown(function(e){if(b(d,e.which)){var t=g(e.which);if(t===!1)return e.preventDefault(),p=!0,!1}}),u.returnSource=function(e){return u.s.onsearch.call(i,e)===!1?!1:(u.render(e),void u.afterRender())},i.keyup(function(){if(p)return p=!1,!1;u.searchterm=this.value;var e={term:u.searchterm};return f=-1,u.s.onbeforesearch.call(i,e)===!1?!1:(this.value.length>=+u.s.minlength?(h=!1,m!==!1&&r.clearTimeout(m),m=r.setTimeout(function(){if(h)return void(h=!1);switch(Object.prototype.toString.call(u.s.src)){case"[object String]":v(u.s.src,e);break;case"[object Function]":u.s.src(u.searchterm,u.returnSource);break;case"[object Array]":var t,r,a=u.s.src,n=new RegExp(u.searchterm.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),"i"),o=[];for(t=0;t<a.length;t++)r=c(a[t]),r.value.match(n)&&(o[o.length]=r);if(u.s.onsearch.call(i,o)===!1)return!1;u.render(o),u.afterRender()}},+u.s.delay)):(h=!0,u.close()),void i.data("streamcomplete",u))});for(var v=function(t,r){l&&l.abort(),l=e.ajax({url:t,type:"post",dataType:"json",beforeSend:function(e){u.s.onbeforeajaxsearch.call(i,e)},data:{payload:JSON.stringify(r)}}).always(function(){l=null}).done(function(e){if("OK"===e.result){if(h)return void(h=!1);if(u.s.onresponse.call(i,e)===!1)return!1;if(m=!1,u.s.onsearch.call(i,e.data)===!1)return!1;u.render(e.data),u.afterRender()}else u.s.onerror.call(i,e)}).fail(function(e){u.s.onajaxerror.call(i,e)})},b=function(e,t){for(var r in e)if(e[r]===t)return!0;return!1},g=function(t){var r=e(".streamcomplete-result"),a=r.length;switch(t){case d.UP:return f=(0>f-1?a:f)-1,e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),e(r[f]).addClass("streamcomplete-result-hover"),!1;case d.DOWN:return f=f+1===a?0:f+1,e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),e(r[f]).addClass("streamcomplete-result-hover"),!1;case d.SPACE:case d.ENTER:case d.TAB:var n=e(".streamcomplete-result-hover");return n.length?(e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),u.close({target:n[0]}),!1):!0;case d.ESC:var n=e(".streamcomplete-result-hover");return n.length?(f=-1,e(".streamcomplete-result-hover").removeClass("streamcomplete-result-hover"),!1):!0}},y=["focusin","focusout"],j=0;j<y.length;j++){var C=y[j];i[C](function(t){var r=e(this).data("streamcomplete");"[object Function]"===Object.prototype.toString.call(r.s["on"+t.type])&&r.s["on"+t.type].call(this,t)})}return i.data("streamcomplete",u),o(),u.s.oninit.call(i),i},setValue:function(t){var r=this;if(r.length>1)return r.each(function(){e(this).streamComplete("clearValue")}),r;var a=r.data("streamcomplete");if(!a)throw n("InstanceError","A call to 'setValue' on an uninitialised object");r[0].value=t.value,r.data("value",t.id);for(var o in t)"id"!==o&&"value"!==o&&r.data(o,t[o]);return r.change()},clearValue:function(t){var r=this;if(r.length>1)return r.each(function(){e(this).streamComplete("clearValue")}),r;var a,o=r.data("streamcomplete");if(!o)throw n("InstanceError","A call to 'setValue' on an uninitialised object");for(r[0].value="",r.data("value",""),a=0;a<(t||[]).length;a++)this.data(t[a],"");return this.change()},updateOpts:function(t){var r=this;if(r.length>1)return r.each(function(){e(this).streamComplete("updateOpts",t)}),r;var a=this.data("streamcomplete");if(!a)throw n("InstanceError","A call to 'setValue' on an uninitialised object");return a.s=e.extend(a.s,t),r.data("streamcomplete",a),this}};e.fn.streamComplete=function(t){var r=this;return c[t]?c[t].apply(r,Array.prototype.slice.call(arguments,1)):"[object Object]"!==Object.prototype.toString.call(t)&&t?void e.error(["The method ",t," does not exist"].join("")):c.init.apply(r,arguments)}}(jQuery,0,this,this.document);
