!function(f,v){"use strict";function y(){}var b=null,t={init:function(e){var o=this,l={instanceid:++v,results:[],s:f.fn.extend({delay:250,minlength:2,classnames:[],clearonemptysearch:!1,appendto:"body",onajaxerror:y,onbeforeajaxsearch:y,onbeforesearch:y,onclose:y,onerror:y,onemptysearchclear:y,onfocusout:y,onfocusin:y,oninit:y,onopen:y,onresponse:y,onsearch:y,onselect:y,preprocessresults:null,requestmethod:"post",src:[],usestandardsyntax:!1},e),searchterm:null,keyboard:{selectpos:-1},outputelement:null},r=!1,c=!1,u={LEFT:37,RIGHT:39,DOWN:40,ENTER:13,SPACE:32,TAB:9,UP:38,ESC:27,SHIFT:16},t=!1;if(!o.length||o.data("streamcomplete"))return o;if(1<o.length)return o.each(function(){f(this).streamComplete(e)}),o;function i(e){return"[object String]"===Object.prototype.toString.call(e)&&(e={id:h,value:e}),!e.label&&e.value&&(e.label=e.value),!e.value&&e.label&&(e.value=e.label),e}l.renderResult=function(e){var t=document.createElement("div");return f(t).html(e.label).data("sc-desc",e).addClass("streamcomplete-result"),t},l.render=function(e){var t,r=o.offset(),a=f.extend({},o[0].getBoundingClientRect()),r={width:a.width,top:r.top+a.height,left:r.left};f(".streamcomplete-body").hide(),(t=l.outputelement).show().data({"sc-results":e}),l.results=e,l.s.onopen.call(o,e,r),"body"===l.s.appendto&&t.css(r),t.empty();for(var s=0;e&&s<e.length;s++){var n=i(e[s]),n=l.renderResult(n);t.append(n)}},l.afterRender=function(){var e=l.outputelement,t=e.data("sc-results"),r="click.streamcomplete-"+l.instanceid;e.data("sc-results",t),f("body").off(r).on(r,l.close)},l.close=function(e){var t=null,r=!1;if(e){var a=f(e.target),s=a.data("streamcomplete"),r=!0;if(a.closest(l.outputelement).length){if(t=a.data("sc-desc"),!1===l.s.onselect.call(o,t))return!1;o[0].value=t.value,o.data("value",t.id),o.data("streamcomplete-item",t)}else if(s&&s.instanceid===l.instanceid)return e.preventDefault(),!1;f("body").off("click.streamcomplete-"+l.instanceid)}l.s.onclose.call(o,{selection:t,results:l.outputelement.hide().data("sc-results")||[],fromevent:r,originalevent:e&&e.originalEvent||!1,fromselectevent:!!e&&f(e.target).hasClass("streamcomplete-result")})},o.keydown(function(e){if(s(u,e.which)&&!1===n(e.which))return e.preventDefault(),e.stopPropagation(),!(t=!0)}),l.returnSource=function(e){if(!1===l.s.onsearch.call(o,e))return!1;l.render(e),l.afterRender()},o.focus(function(){var e=(o.data("streamcomplete")||{}).results;e&&e.length&&(l.render(e),l.afterRender())}),o.keyup(function(e){if(t)return t=!1;if(e.which===u.SHIFT)return!1;if(!(l.results||[]).length||e.which!==u.LEFT&&e.which!==u.RIGHT&&e.which!==u.ENTER){l.searchterm=this.value;var n={term:l.searchterm};if(!(l.keyboard.selectpos=-1)===l.s.onbeforesearch.call(o,n))return!1;this.value.length>=+l.s.minlength?((c=!1)!==r&&window.clearTimeout(r),r=window.setTimeout(function(){if(c)c=!1;else switch(l.outputelement.data({"sc-results":[]}),l.results=[],Object.prototype.toString.call(l.s.src)){case"[object String]":(l.s.usestandardsyntax?p:d)(l.s.src,n);break;case"[object Function]":l.s.src(l.searchterm,l.returnSource);break;case"[object Array]":for(var e,t=l.s.src,r=new RegExp(l.searchterm.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),"i"),a=[],s=0;s<t.length;s++)(e=i(t[s])).value.match(r)&&(a[a.length]=e);if(!1===l.s.onsearch.call(o,a))return!1;l.render(a),l.afterRender()}},+l.s.delay)):(c=!0,l.close()),!this.value.length&&l.s.clearonemptysearch&&!1!==l.s.onemptysearchclear.call(o)&&(l.results=[]),o.data("streamcomplete",l)}else e.which===u.ENTER&&o.focus()});for(var a,d=function(e,t){b&&b.abort(),b=f.ajax({url:e,type:l.s.requestmethod,dataType:"json",beforeSend:function(e){l.s.onbeforeajaxsearch.call(o,e)},data:{payload:JSON.stringify(t)}}).always(function(){b=null}).done(function(e){if("OK"===e.result){if(!c)return l.s.preprocessresults&&(e.data=l.s.preprocessresults(e.data)),!1!==l.s.onresponse.call(o,e)&&((r=!1)!==l.s.onsearch.call(o,e.data)&&(l.render(e.data),void l.afterRender()));c=!1}else l.s.onerror.call(o,e)}).fail(function(e){l.s.onajaxerror.call(o,e)})},p=function(e,t){b&&b.abort(),b=f.ajax({url:e,type:l.s.requestmethod,dataType:"json",beforeSend:function(e){l.s.onbeforeajaxsearch.call(o,e)},data:t}).always(function(){b=null}).done(function(e){if(e&&e.data){if(!c)return l.s.preprocessresults&&(e.data=l.s.preprocessresults(e.data)),!1!==l.s.onresponse.call(o,e)&&((r=!1)!==l.s.onsearch.call(o,e.data)&&(l.render(e.data),void l.afterRender()));c=!1}else l.s.onerror.call(o,e)}).fail(function(e){l.s.onajaxerror.call(o,e)})},s=function(e,t){for(var r in e)if(e[r]===t)return!0;return!1},n=function(e){var t,r=l.outputelement,a=f(".streamcomplete-result",r),s=a.length;switch(e){case u.UP:return l.keyboard.selectpos=(l.keyboard.selectpos-1<0?s:l.keyboard.selectpos)-1,f(".streamcomplete-result-hover",r).removeClass("streamcomplete-result-hover"),f(a[l.keyboard.selectpos]).addClass("streamcomplete-result-hover"),!1;case u.DOWN:return l.keyboard.selectpos=l.keyboard.selectpos+1===s?0:l.keyboard.selectpos+1,f(".streamcomplete-result-hover",r).removeClass("streamcomplete-result-hover"),f(a[l.keyboard.selectpos]).addClass("streamcomplete-result-hover"),!1;case u.SPACE:case u.ENTER:case u.TAB:return(t=f(".streamcomplete-result-hover",r)).length?(f(".streamcomplete-result-hover",r).removeClass("streamcomplete-result-hover"),l.close({target:t[0]}),!1):!0;case u.ESC:return(t=f(".streamcomplete-result-hover",r)).length?(l.keyboard.selectpos=-1,f(".streamcomplete-result-hover",r).removeClass("streamcomplete-result-hover"),!1):!0;case u.SHIFT:return!1}},m=["focusin","focusout"],h=0;h<m.length;h++)o[m[h]](function(e){var t=f(this).data("streamcomplete");"[object Function]"===Object.prototype.toString.call(t.s["on"+e.type])&&t.s["on"+e.type].call(this,e)});return o.data("streamcomplete",l),a=["streamcomplete-body","streamcomplete-body-iid-"+l.instanceid].concat(l.s.classnames),f("."+a.join(".")).length||(f(l.s.appendto).append(f("<div>",{class:a.join(" ")})),l.outputelement=f("."+a.join("."))),l.s.oninit.call(o),o},setValue:function(e){var t,r=this;if(1<r.length)return r.each(function(){f(this).streamComplete("clearValue")}),r;if(!r.data("streamcomplete"))throw a("InstanceError","A call to 'setValue' on an uninitialised object");for(t in r[0].value=e.value,r.data("value",e.id),e)"id"!==t&&"value"!==t&&r.data(t,e[t]);return r.change()},clearValue:function(e){var t,r=this;if(1<r.length)return r.each(function(){f(this).streamComplete("clearValue")}),r;if(!r.data("streamcomplete"))throw a("InstanceError","A call to 'setValue' on an uninitialised object");for(r[0].value="",r.data("value",""),t=0;t<(e||[]).length;t++)this.data(e[t],"");return this.change()},updateOpts:function(e){if(1<this.length)return this.each(function(){f(this).streamComplete("updateOpts",e)}),this;var t=this.data("streamcomplete");if(!t)throw a("InstanceError","A call to 'setValue' on an uninitialised object");return t.s=f.extend(t.s,e),this.data("streamcomplete",t),this}};function a(e,t){return{name:"StreamComplete::"+e,level:"Cannot continue",message:t,htmlMessage:t,toString:function(){return["StreamComplete::",e," - ",t].join("")}}}f.fn.streamComplete=function(e){return t[e]?t[e].apply(this,Array.prototype.slice.call(arguments,1)):"[object Object]"!==Object.prototype.toString.call(e)&&e?void f.error(["The method ",e," does not exist"].join("")):t.init.apply(this,arguments)}}(jQuery,0);
