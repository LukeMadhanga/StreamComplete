!function(f,v,y,b){"use strict";function g(){}var j=null,t={init:function(e){var c=this,u={instanceid:++v,results:[],s:f.fn.extend({delay:250,minlength:2,classnames:[],clearonemptysearch:!1,appendto:"body",onajaxerror:g,onbeforeajaxsearch:g,onbeforesearch:g,onclose:g,onerror:g,onemptysearchclear:g,onfocusout:g,onfocusin:g,oninit:g,onopen:g,onresponse:g,onsearch:g,onselect:g,preprocessresults:null,requestmethod:"post",src:[],usestandardsyntax:!1},e),searchterm:null,keyboard:{selectpos:-1},outputelement:null},r=!1,o=!1,l={LEFT:37,RIGHT:39,DOWN:40,ENTER:13,SPACE:32,TAB:9,UP:38,ESC:27,SHIFT:16},t=!1;if(!c.length||c.data("streamcomplete"))return c;if(1<c.length)return c.each(function(){f(this).streamComplete(e)}),c;function i(e){switch(Object.prototype.toString.call(e)){case"[object String]":e={id:h,value:e}}return!e.label&&e.value&&(e.label=e.value),!e.value&&e.label&&(e.value=e.label),e}u.renderResult=function(e){var t=b.createElement("div");return f(t).html(e.label).data("sc-desc",e).addClass("streamcomplete-result"),t},u.render=function(e){var t,r=c.offset(),a=f.extend({},c[0].getBoundingClientRect()),s={width:a.width,top:r.top+a.height,left:r.left};f(".streamcomplete-body").hide(),(t=u.outputelement).show().data({"sc-results":e}),u.results=e,u.s.onopen.call(c,e,s),"body"===u.s.appendto&&t.css(s),t.empty();for(var n=0;e&&n<e.length;n++){var o=i(e[n]),l=u.renderResult(o);t.append(l)}},u.afterRender=function(){var e=u.outputelement,t=e.data("sc-results"),r="click.streamcomplete-"+u.instanceid;e.data("sc-results",t),f("body").off(r).on(r,u.close)},u.close=function(e){var t=null,r=!1;if(e){var a=f(e.target),s=a.data("streamcomplete");if(r=!0,a.closest(u.outputelement).length){if(t=a.data("sc-desc"),!1===u.s.onselect.call(c,t))return!1;c[0].value=t.value,c.data("value",t.id),c.data("streamcomplete-item",t)}else if(s&&s.instanceid===u.instanceid)return e.preventDefault(),!1;f("body").off("click.streamcomplete-"+u.instanceid)}u.s.onclose.call(c,{selection:t,results:u.outputelement.hide().data("sc-results")||[],fromevent:r,originalevent:e&&e.originalEvent||!1,fromselectevent:!!e&&f(e.target).hasClass("streamcomplete-result")})},c.keydown(function(e){if(s(l,e.which)&&!1===n(e.which))return e.preventDefault(),!(t=!0)}),u.returnSource=function(e){if(!1===u.s.onsearch.call(c,e))return!1;u.render(e),u.afterRender()},c.focus(function(){var e=(c.data("streamcomplete")||{}).results;e&&e.length&&(u.render(e),u.afterRender())}),c.keyup(function(e){if(t)return t=!1;if(e.which===l.SHIFT)return!1;if(!(u.results||[]).length||e.which!==l.LEFT&&e.which!==l.RIGHT&&e.which!==l.ENTER){u.searchterm=this.value;var n={term:u.searchterm};if(!(u.keyboard.selectpos=-1)===u.s.onbeforesearch.call(c,n))return!1;this.value.length>=+u.s.minlength?((o=!1)!==r&&y.clearTimeout(r),r=y.setTimeout(function(){if(o)o=!1;else switch(u.outputelement.data({"sc-results":[]}),u.results=[],Object.prototype.toString.call(u.s.src)){case"[object String]":u.s.usestandardsyntax?p(u.s.src,n):d(u.s.src,n);break;case"[object Function]":u.s.src(u.searchterm,u.returnSource);break;case"[object Array]":var e,t,r=u.s.src,a=new RegExp(u.searchterm.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),"i"),s=[];for(e=0;e<r.length;e++)(t=i(r[e])).value.match(a)&&(s[s.length]=t);if(!1===u.s.onsearch.call(c,s))return!1;u.render(s),u.afterRender()}},+u.s.delay)):(o=!0,u.close()),!this.value.length&&u.s.clearonemptysearch&&!1!==u.s.onemptysearchclear.call(c)&&(u.results=[]),c.data("streamcomplete",u)}else e.which===l.ENTER&&c.focus()});for(var a,d=function(e,t){j&&j.abort(),j=f.ajax({url:e,type:u.s.requestmethod,dataType:"json",beforeSend:function(e){u.s.onbeforeajaxsearch.call(c,e)},data:{payload:JSON.stringify(t)}}).always(function(){j=null}).done(function(e){if("OK"===e.result){if(o)return void(o=!1);if(u.s.preprocessresults&&(e.data=u.s.preprocessresults(e.data)),!1===u.s.onresponse.call(c,e))return!1;if((r=!1)===u.s.onsearch.call(c,e.data))return!1;u.render(e.data),u.afterRender()}else u.s.onerror.call(c,e)}).fail(function(e){u.s.onajaxerror.call(c,e)})},p=function(e,t){j&&j.abort(),j=f.ajax({url:e,type:u.s.requestmethod,dataType:"json",beforeSend:function(e){u.s.onbeforeajaxsearch.call(c,e)},data:t}).always(function(){j=null}).done(function(e){if(e&&e.data){if(o)return void(o=!1);if(u.s.preprocessresults&&(e.data=u.s.preprocessresults(e.data)),!1===u.s.onresponse.call(c,e))return!1;if((r=!1)===u.s.onsearch.call(c,e.data))return!1;u.render(e.data),u.afterRender()}else u.s.onerror.call(c,e)}).fail(function(e){u.s.onajaxerror.call(c,e)})},s=function(e,t){for(var r in e)if(e[r]===t)return!0;return!1},n=function(e){var t=u.outputelement,r=f(".streamcomplete-result",t),a=r.length;switch(e){case l.UP:return u.keyboard.selectpos=(u.keyboard.selectpos-1<0?a:u.keyboard.selectpos)-1,f(".streamcomplete-result-hover",t).removeClass("streamcomplete-result-hover"),f(r[u.keyboard.selectpos]).addClass("streamcomplete-result-hover"),!1;case l.DOWN:return u.keyboard.selectpos=u.keyboard.selectpos+1===a?0:u.keyboard.selectpos+1,f(".streamcomplete-result-hover",t).removeClass("streamcomplete-result-hover"),f(r[u.keyboard.selectpos]).addClass("streamcomplete-result-hover"),!1;case l.SPACE:case l.ENTER:case l.TAB:return!(s=f(".streamcomplete-result-hover",t)).length||(f(".streamcomplete-result-hover",t).removeClass("streamcomplete-result-hover"),u.close({target:s[0]}),!1);case l.ESC:var s;return!(s=f(".streamcomplete-result-hover",t)).length||(u.keyboard.selectpos=-1,f(".streamcomplete-result-hover",t).removeClass("streamcomplete-result-hover"),!1);case l.SHIFT:return!1}},m=["focusin","focusout"],h=0;h<m.length;h++){c[m[h]](function(e){var t=f(this).data("streamcomplete");"[object Function]"===Object.prototype.toString.call(t.s["on"+e.type])&&t.s["on"+e.type].call(this,e)})}return c.data("streamcomplete",u),a=function(){var e=["streamcomplete-body","streamcomplete-body-iid-"+u.instanceid];return e=e.concat(u.s.classnames)}(),f("."+a.join(".")).length||(f(u.s.appendto).append(f("<div>",{class:a.join(" ")})),u.outputelement=f("."+a.join("."))),u.s.oninit.call(c),c},setValue:function(e){var t=this;if(1<t.length)return t.each(function(){f(this).streamComplete("clearValue")}),t;if(!t.data("streamcomplete"))throw a("InstanceError","A call to 'setValue' on an uninitialised object");for(var r in t[0].value=e.value,t.data("value",e.id),e)"id"!==r&&"value"!==r&&t.data(r,e[r]);return t.change()},clearValue:function(e){var t,r=this;if(1<r.length)return r.each(function(){f(this).streamComplete("clearValue")}),r;if(!r.data("streamcomplete"))throw a("InstanceError","A call to 'setValue' on an uninitialised object");for(r[0].value="",r.data("value",""),t=0;t<(e||[]).length;t++)this.data(e[t],"");return this.change()},updateOpts:function(e){if(1<this.length)return this.each(function(){f(this).streamComplete("updateOpts",e)}),this;var t=this.data("streamcomplete");if(!t)throw a("InstanceError","A call to 'setValue' on an uninitialised object");return t.s=f.extend(t.s,e),this.data("streamcomplete",t),this}};function a(e,t){return{name:"StreamComplete::"+e,level:"Cannot continue",message:t,htmlMessage:t,toString:function(){return["StreamComplete::",e," - ",t].join("")}}}f.fn.streamComplete=function(e){return t[e]?t[e].apply(this,Array.prototype.slice.call(arguments,1)):"[object Object]"!==Object.prototype.toString.call(e)&&e?void f.error(["The method ",e," does not exist"].join("")):t.init.apply(this,arguments)}}(jQuery,0,this,this.document);
